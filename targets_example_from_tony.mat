botpath = 'E:\AD\20200722M99\bots.cfg';
targetfolder = fullfile('Z:\mSLM_B115\SetupFiles\Experiment\22-Jul-2020\M99','targets');

BOTS = xml2struct(botpath);
nBOTS = length(BOTS.PVBOTs.Region);
botXY = zeros(nBOTS,2);
for b = 1:nBOTS
 botXY(b,:) = [str2double(BOTS.PVBOTs.Region{b}.Attributes.x) str2double(BOTS.PVBOTs.Region{b}.Attributes.y)];
end

shift = str2double(BOTS.PVBOTs.Region{b}.Attributes.height)/2; %PV gives upperright corner and not center of BOT
botXY = botXY+shift; %shift BOT coordinates to get center values

%coordinatesLiveA = botXY(1:4:end,:);
%coordinatesLiveB = botXY(3:4:end,:); 
coordinatesLiveA = botXY(1:10,:);
coordinatesLiveB = botXY(11:20,:);
coordinatesLiveC = botXY(21:30,:); 


C.loc1 = cat(2,coordinatesLiveA,zeros(size(coordinatesLiveA,1),1));
C.loc2 = cat(2,coordinatesLiveB,zeros(size(coordinatesLiveB,1),1));
C.loc3 = cat(2,coordinatesLiveC,zeros(size(coordinatesLiveC,1),1));
nCases = length(fieldnames(C));
caseNames = fieldnames(C);

mkdir(targetfolder)
bw = zeros(512,512,3);

for caseIdx = 1:nCases
    
    experimentS.targets{1,1} = [C.(caseNames{caseIdx})]
    experimentS.zrange = [min(experimentS.targets{1,1}(:,3)) max(experimentS.targets{1,1}(:,3))];
    experimentS.im{1,1} = uint16(zeros(512,512));
    experimentS.im{1,2} = uint16(zeros(512,512));
    
    freq = 20; % in Hz
    dt = 2; % length of spiral in ms
    pulseTimesIdx  = 1:1/freq*1000/dt:200/dt;
    idx = mod(pulseTimesIdx,2)<1;
    pulseTimesIdx = floor(pulseTimesIdx);
    pulseTimesIdx(idx) = pulseTimesIdx(idx)+1;
    experimentS.targetsGroup = cell(1,max(pulseTimesIdx));
    if mod(length(experimentS.targetsGroup),2) == 1
        experimentS.targetsGroup{end+1} = {};
    end
    for i = 1:length(pulseTimesIdx)
        experimentS.targetsGroup{pulseTimesIdx(i)} = [experimentS.targets{1}];
    end
    save(fullfile(targetfolder,['ens_',caseNames{caseIdx},'.mat']),'experimentS')
    
    % plot targets on mean image
    fig = figure;
    imagesc(bw,[0.0 0.2])
    hold on
    colormap 'gray'
    axis image %pixel are quadratic
    axis off
    targetCoordinatesXYZ = experimentS.targets{1};
    for idx = 1:size(targetCoordinatesXYZ,1)
        plot(targetCoordinatesXYZ(idx,1),targetCoordinatesXYZ(idx,2),'ro','MarkerSize',8,'linewidth',2)
    end
    title(caseNames{caseIdx})
    saveas(fig,fullfile(targetfolder,sprintf('%s.png',caseNames{caseIdx})));
end

matfiles = dir(fullfile(targetfolder,'*.mat'));
outfile = fullfile(targetfolder,'stim3Dl23.txt');
fid = fopen(outfile,'w');

for iF=1:numel(matfiles)
    filestr = fullfile(matfiles(iF).folder,matfiles(iF).name);
    fprintf(fid,'%s \t 1 \r\n',filestr);
end
fclose(fid);
